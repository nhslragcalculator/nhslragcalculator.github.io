<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RAG calculator</title>
  <style>
    body{
      font-family:Arial, sans-serif;
      background:#f3f6fb;
      color:#222;
      margin:0;
      padding:24px;
    }
    .container{
      max-width:900px;
      margin:auto;
      background:#fff;
      padding:24px;
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    h1{margin-top:0}
    label{display:block;margin-top:12px;font-weight:bold}
    input,select{
      width:100%;
      padding:8px;
      margin-top:4px;
      box-sizing:border-box;
      border:1px solid #ccc;
      border-radius:6px;
    }
    button{
      margin-top:20px;
      padding:10px 14px;
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-weight:bold;
    }
    button:hover{background:#0056b3;}
    #result{
      margin-top:20px;
      padding:14px;
      border-radius:10px;
      background:#f8f9fb;
      border:1px solid #e0e4ea;
    }
    .green{color:green; font-weight:bold;}
    .amber{color:orange; font-weight:bold;}
    .red{color:red; font-weight:bold;}
    ul{margin-top:6px; padding-left:18px;}
    li{margin-bottom:4px;}

    /* Black info icon with tooltip */
    .info-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      line-height: 16px;
      border-radius: 50%;
      border: 1.5px solid #000; /* black outline */
      background: transparent;   /* transparent inside */
      color: #000;               /* black "i" */
      text-align: center;
      font-size: 12px;
      font-weight: bold;
      margin-left: 6px;
      cursor: pointer;
      position: relative;
    }
    .info-icon .tooltip {
      visibility: hidden;
      opacity: 0;
      width: max-content;
      max-width: 250px;
      background-color: #000; /* black background */
      color: #fff;            /* white text */
      text-align: left;
      border-radius: 6px;
      padding: 6px 10px;
      position: absolute;
      z-index: 1;
      top: -5px;
      left: 105%;
      transition: opacity 0.3s;
      font-size: 12px;
      line-height: 1.3;
      white-space: pre-wrap;
    }
    .info-icon:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>RAG Calculator</h1>

    <label>BMI</label>
    <input type="number" id="bmi" placeholder="Enter BMI" step="0.1" min="0">

    <label>Cardiac issues</label>
    <select id="cardiac">
      <option value="0">None</option>
      <option value="1">Yes in the past but I have no/minimal symptoms now</option>
      <option value="3">Yes, and I have ongoing symptoms</option>
    </select>

    <label>Respiratory issues</label>
    <select id="respiratory">
      <option value="0">None</option>
      <option value="1">Yes in the past but I have no/minimal symptoms now</option>
      <option value="3">Yes, and I have ongoing symptoms</option>
    </select>

    <label>Neurological issues</label>
    <select id="neurological">
      <option value="0">None</option>
      <option value="1">Yes in the past but I have no/minimal symptoms now</option>
      <option value="3">Yes, and I have ongoing symptoms</option>
    </select>

    <label>Psychiatric issues</label>
    <select id="psychiatric">
      <option value="0">None</option>
      <option value="1">Yes in the past but I have no/minimal symptoms now</option>
      <option value="3">Yes, and I have ongoing symptoms</option>
    </select>

    <label>Can they get out of the house on their own?</label>
    <select id="getOut">
      <option value="0">Yes</option>
      <option value="1">No</option>
    </select>

    <label>Diabetes</label>
    <select id="diabetes">
      <option value="0">None</option>
      <option value="1">Well controlled diabetes with no more than 2 medications</option>
      <option value="2">On Insulin or more than 2 diabetic medications</option>
      <option value="3">On Insulin and more than 2 other diabetic medications</option>
    </select>

    <label>Age &gt;80 for knee or &gt;85 for hip</label>
    <select id="ageFlag">
      <option value="0">No</option>
      <option value="1">Yes</option>
    </select>

    <label>Recent hospital admission (past 6 weeks)</label>
    <select id="recentAdmit">
      <option value="0">No</option>
      <option value="1">Yes</option>
    </select>

    <label>Are you known to be anaemic</label>
    <select id="anaemia">
      <option value="0">No / Don't know</option>
      <option value="1">Yes - stable and receiving treatment</option>
      <option value="3">Yes and waiting for further investigations</option>
    </select>

    <label>On renal replacement therapy</label>
    <select id="rrt">
      <option value="0">No</option>
      <option value="1">Yes</option>
    </select>

    <label>How many medications are you on (apart from pain killers)?</label>
    <input type="number" id="numMeds" placeholder="Enter number" min="0">

    <label>Revision surgery, complex primary or bilateral joints</label>
    <select id="revision">
      <option value="0">No</option>
      <option value="3">Yes</option>
    </select>

    <label>On Clopidogrel / Ticagrelor / Prasugrel</label>
    <select id="antiplatelet">
      <option value="0">No</option>
      <option value="1">Yes</option>
    </select>

    <label>On DOAC (Apixaban / Rivaroxaban / Dabigatran etc)</label>
    <select id="doac">
      <option value="0">No</option>
      <option value="1">Yes</option>
    </select>

    <label>On GLP1 agonist (Ozempic / Mounjaro / Wegovy / Tirzepatide / Rybelsus etc)</label>
    <select id="glp1">
      <option value="0">No</option>
      <option value="1">Yes</option>
    </select>

    <label>On Immunosuppressants</label>
    <select id="immuno">
      <option value="0">No</option>
      <option value="1">Yes</option>
    </select>

    <label>Patient needs more than 24 hours notice</label>
    <select id="notice">
      <option value="0">No</option>
      <option value="1">Yes</option>
    </select>

    <button onclick="calculateScore()">Calculate Score</button>

    <div id="result"></div>
  </div>

  <script>
    function calculateScore(){
      let score = 0;
      let breakdown = [];

      // Updated BMI scoring
      const bmi = parseFloat(document.getElementById('bmi').value);
      let bmiPoints = 0;
      if (!isNaN(bmi)) {
        if (bmi < 18) bmiPoints = 3;
        else if (bmi >= 18 && bmi < 20) bmiPoints = 1;
        else if (bmi >= 20 && bmi < 35) bmiPoints = 0;
        else if (bmi >= 35 && bmi < 40) bmiPoints = 1;
        else if (bmi >= 40) bmiPoints = 3;

        score += bmiPoints;
        if (bmiPoints > 0) breakdown.push(`BMI (${bmi.toFixed(1)}) = ${bmiPoints} pt${bmiPoints > 1 ? 's' : ''}`);
      }

      const fields = [
        {id:'cardiac', label:'Cardiac issues'},
        {id:'respiratory', label:'Respiratory issues'},
        {id:'neurological', label:'Neurological issues'},
        {id:'psychiatric', label:'Psychiatric issues'},
        {id:'getOut', label:'Cannot get out of house'},
        {id:'ageFlag', label:'Age threshold exceeded'},
        {id:'recentAdmit', label:'Recent hospital admission'},
        {id:'anaemia', label:'Anaemia'},
        {id:'revision', label:'Revision/complex primary'},
      ];

      fields.forEach(f=>{
        let val = parseInt(document.getElementById(f.id).value) || 0;
        if(val>0){
          score += val;
          breakdown.push(`${f.label} = ${val} pt${val>1?'s':''}`);
        }
      });

      const meds = parseInt(document.getElementById('numMeds').value) || 0;
      if (meds >= 5){
        score += 1;
        breakdown.push(`Non-analgesic medications (${meds}) = 1 pt`);
      }

      const diabetesPts = parseInt(document.getElementById('diabetes').value) || 0;
      if(diabetesPts>0){
        score += diabetesPts;
        const diabetesLabel = document.getElementById('diabetes').options[document.getElementById('diabetes').selectedIndex].text;
        breakdown.push(`Diabetes: ${diabetesLabel} = ${diabetesPts} pt${diabetesPts>1?'s':''}`);
      }

// Different scoring for these three
const antiplatelet = parseInt(document.getElementById('antiplatelet').value);
const doac = parseInt(document.getElementById('doac').value);
const immuno = parseInt(document.getElementById('immuno').value);

// Antiplatelet = 2 points
if (antiplatelet > 0) {
  score += 2;
  breakdown.push('On Antiplatelet = 2 pts');
}

// ---- VARIABLE SCORING FOR ANTIPLATELET & DOAC ----

// At this point, 'score' includes everything EXCEPT antiplatelet + DOAC

let baseScore = score; // store current total before adding these

function getDrugPoints(base) {
  if (base === 0) return 3;
  if (base === 1) return 2;
  if (base === 2) return 1;
  return 0; // base >= 3
}

const variablePoints = getDrugPoints(baseScore);

// Antiplatelet
if (antiplatelet > 0) {
  score += variablePoints;
  breakdown.push(`On Antiplatelet = ${variablePoints} pt${variablePoints !== 1 ? 's' : ''}`);
}

// DOAC
if (doac > 0) {
  score += variablePoints;
  breakdown.push(`On DOAC = ${variablePoints} pt${variablePoints !== 1 ? 's' : ''}`);
}

      let risk='', riskClass='';
      if (score >= 6){ risk='Red'; riskClass='red'; }
      else if (score >= 3){ risk='Amber'; riskClass='amber'; }
      else { risk='Green'; riskClass='green'; }

      const autoNoFields = ['rrt','antiplatelet','doac','glp1','immuno','notice'];
      let autoNo = autoNoFields.some(id => parseInt(document.getElementById(id).value) > 0);

      if (parseInt(document.getElementById('revision').value) === 3 ||
          parseInt(document.getElementById('anaemia').value) === 3) {
        autoNo = true;
      }

      let suitable = "Yes";
      let suitableClass = "green";
      if(score > 8 || autoNo) {
        suitable = "No";
        suitableClass = "red";
      }

      let fourJoint = "Yes";
      let fourJointClass = "green";
      let fourJointReason = "";

      let reasons = [];
      if (risk !== 'Green') reasons.push(`RAG pathway is ${risk}`);
      if (!isNaN(bmi) && bmi >= 35) reasons.push(`BMI is ${bmi.toFixed(1)} (â‰¥ 35)`);

      if (reasons.length > 0) {
        fourJoint = "No";
        fourJointClass = "red";
        fourJointReason = reasons.join(" and ");
      }

      document.getElementById('result').innerHTML =
        `<strong>Total Score: ${score}</strong><br>
         <span class="${riskClass}"><strong>RAG Category: ${risk}</strong></span><br>
         <strong>Suitable to come in on same day?:</strong>
         <span class="${suitableClass}">${suitable}</span><br>
         <strong>Suitable for 4 joint list?:</strong>
         <span class="${fourJointClass}">
           ${fourJoint}
           ${fourJointReason ? `<span class="info-icon">i<span class="tooltip">${fourJointReason}</span></span>` : ''}
         </span>
         <div style="margin-top:10px;">
         <strong>Breakdown:</strong>
         <ul>${breakdown.map(x=>`<li>${x}</li>`).join('')}</ul>
         </div>`;
    }
  </script>
</body>
</html>
